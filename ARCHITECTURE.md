# ğŸ—ï¸ PolySniper æ¶æ„è¯´æ˜

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å‰ç«¯ (React)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ MatchCard   â”‚  â”‚ DetailModal  â”‚  â”‚  SignalCard      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                â”‚                    â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                          â”‚                                   â”‚
â”‚                  WebSocket Client                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    WebSocket
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åç«¯ (Node.js + Express)                   â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Data Aggregator (æ ¸å¿ƒ)                   â”‚   â”‚
â”‚  â”‚  - è·å– ESPN æ¯”èµ›æ•°æ® (æ¯ 5 ç§’)                       â”‚   â”‚
â”‚  â”‚  - åŒ¹é… Polymarket ä»·æ ¼                               â”‚   â”‚
â”‚  â”‚  - è®¡ç®—å¥—åˆ©ä¿¡å·                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚      â”‚                         â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ ESPN Service â”‚        â”‚ Polymarket    â”‚                  â”‚
â”‚  â”‚              â”‚        â”‚ Service       â”‚                  â”‚
â”‚  â”‚ - Scoreboard â”‚        â”‚ - Market Data â”‚                  â”‚
â”‚  â”‚ - Summary    â”‚        â”‚ - Token Price â”‚                  â”‚
â”‚  â”‚ - Injuries   â”‚        â”‚               â”‚                  â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚      â”‚                         â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                         â”‚
       â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ESPN API   â”‚        â”‚ Polymarket   â”‚
â”‚              â”‚        â”‚   Gamma API  â”‚
â”‚ - æ¯”èµ›èµ›ç¨‹    â”‚        â”‚ - Events     â”‚
â”‚ - å®æ—¶æ¯”åˆ†    â”‚        â”‚ - Markets    â”‚
â”‚ - èƒœç‡é¢„æµ‹    â”‚        â”‚ - Prices     â”‚
â”‚ - ä¼¤ç—…ä¿¡æ¯    â”‚        â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ•°æ®æµ

### 1. ESPN ä½œä¸ºä¸»æ•°æ®æº

```typescript
// 1. è·å–æ¯”èµ›æ•°æ®
ESPN Scoreboard API â†’ æ¯”èµ›åˆ—è¡¨ (ä»Šå¤©+æ˜å¤©+åå¤©)
  â†“
è¿‡æ»¤å·²ç»“æŸæ¯”èµ› (status !== 'post')
  â†“
éå†æ¯åœºæ¯”èµ›
```

### 2. è·å–è¯¦ç»†æ•°æ®

```typescript
// 2. å¹¶è¡Œè¯·æ±‚è¯¦ç»†æ•°æ®
Promise.allSettled([
  espnService.getGameWinProbability(gameId),  // èƒœç‡ + ä¼¤ç—…
  polymarketService.searchNBAMarkets(team1, team2)  // ä»·æ ¼
])
  â†“
åˆå¹¶æ•°æ® â†’ UnifiedMatch
  â†“
è®¡ç®—å¥—åˆ©ä¿¡å· (arbitrageEngine)
  â†“
WebSocket æ¨é€ç»™å‰ç«¯
```

### 3. æ•°æ®ç»“æ„

```typescript
interface UnifiedMatch {
  id: string;
  homeTeam: { id, name, score };
  awayTeam: { id, name, score };
  status: 'PRE' | 'LIVE' | 'FINAL';
  startTime: string;
  
  // ESPN æ•°æ®
  espn: {
    homeWinProb: number;
    awayWinProb: number;
    pregameHomeWinProb: number;
    pregameAwayWinProb: number;
    injuries: InjuryReport[];
  };
  
  // Polymarket æ•°æ®
  poly: {
    marketId: string;
    homePrice: number;
    awayPrice: number;
  };
  
  // å¥—åˆ©ä¿¡å·
  signals: ArbitrageSignal[];
  
  dataCompleteness: {
    hasESPNData: boolean;
    hasPolyData: boolean;
  };
}
```

## æ ¸å¿ƒæœåŠ¡

### ESPN Service

```typescript
class ESPNService {
  // è·å–æŒ‡å®šæ—¥æœŸçš„æ¯”èµ›
  async getScoreboard(date?: string): Promise<any>
  
  // è·å–æ¯”èµ›è¯¦ç»†æ•°æ®ï¼ˆèƒœç‡ + ä¼¤ç—…ï¼‰
  async getGameWinProbability(gameId: string): Promise<ESPNData>
  
  // æ ¹æ®é˜ŸåæŸ¥æ‰¾æ¯”èµ›
  async getWinProbabilityByTeams(home, away, date): Promise<ESPNData>
}
```

**å…³é”®ç‰¹æ€§ï¼š**
- âœ… æ”¯æŒæ—¥æœŸå‚æ•°æŸ¥è¯¢æœªæ¥æ¯”èµ›
- âœ… ä½¿ç”¨ Summary API è·å–å®Œæ•´æ•°æ®
- âœ… ä» MoneyLine è®¡ç®—éšå«æ¦‚ç‡
- âœ… è§£æä¼¤ç—…è¯¦æƒ…

### Polymarket Service

```typescript
class PolymarketService {
  // æœç´¢ NBA å¸‚åœº
  async searchNBAMarkets(homeTeam, awayTeam): Promise<PolymarketData>
}
```

**åŒ¹é…é€»è¾‘ï¼š**
1. é€šè¿‡ series_id='10345' è¿‡æ»¤ NBA å¸‚åœº
2. ä½¿ç”¨é˜Ÿåå…³é”®è¯åŒ¹é…
3. æ—¶é—´æ ¡éªŒï¼ˆendDate >= startTimeï¼‰

### Data Aggregator

```typescript
class DataAggregator {
  // ä¸»æ›´æ–°å¾ªç¯ (æ¯ 5 ç§’)
  private async updateAllMatches(): Promise<void>
  
  // å•åœºæ¯”èµ›æ›´æ–°
  private async updateMatch(espnGame): Promise<void>
  
  // ESPN é˜Ÿå â†’ Polymarket æœç´¢
  private async searchPolymarketByESPNTeams(home, away): Promise<any>
}
```

## é˜Ÿåæ˜ å°„

```typescript
// config/teamMappings.ts
interface TeamMapping {
  espnName: string;      // "Boston Celtics"
  espnId: string;        // "2"
  hupuName: string;      // "å‡¯å°”ç‰¹äºº" (ç”¨äº Polymarket æœç´¢)
  polyKeywords: string[]; // ["Celtics", "BOS"]
}
```

**æ˜ å°„æµç¨‹ï¼š**
```
ESPN "Boston Celtics" 
  â†’ æŸ¥æ‰¾æ˜ å°„è¡¨
  â†’ hupuName "å‡¯å°”ç‰¹äºº"
  â†’ Polymarket API æœç´¢
```

## æ€§èƒ½ä¼˜åŒ–

### 1. å¹¶è¡Œè¯·æ±‚
```typescript
// âŒ ä¸²è¡Œ (æ…¢)
const espn = await espnService.get();
const poly = await polyService.get();

// âœ… å¹¶è¡Œ (å¿«)
const [espn, poly] = await Promise.allSettled([
  espnService.get(),
  polyService.get()
]);
```

### 2. æ•°æ®ç¼“å­˜
- ESPN Scoreboard: 10 ç§’ç¼“å­˜
- ESPN Summary: æŒ‰éœ€è·å–ï¼Œä¸ç¼“å­˜ï¼ˆå®æ—¶æ•°æ®ï¼‰
- Polymarket: æŒ‰éœ€è·å–

### 3. æ™ºèƒ½è¿‡æ»¤
- åªå¤„ç†æœªç»“æŸçš„æ¯”èµ› (`status !== 'post'`)
- æŸ¥è¯¢æœªæ¥ 3 å¤©çš„æ¯”èµ›æ•°æ®

## API å“åº”æ—¶é—´

| æœåŠ¡ | ç«¯ç‚¹ | å“åº”æ—¶é—´ |
|------|------|---------|
| ESPN | Scoreboard | ~200ms |
| ESPN | Summary | ~300-500ms |
| Polymarket | Events | ~400-600ms |
| **æ€»è®¡** | **å•åœºæ¯”èµ›** | **~1s** |

## WebSocket é€šä¿¡

### å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨

```typescript
// è®¢é˜…æ¯”èµ›æ›´æ–°
socket.emit('subscribe', { matchIds: ['all'] });

// å–æ¶ˆè®¢é˜…
socket.emit('unsubscribe', { matchIds: ['123'] });
```

### æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯

```typescript
// åˆå§‹æ•°æ®
socket.emit('matchesUpdate', { 
  type: 'initial', 
  matches: [...] 
});

// å¢é‡æ›´æ–°
socket.emit('matchesUpdate', { 
  type: 'update', 
  matches: [...] 
});

// å¥—åˆ©ä¿¡å·
socket.emit('signalAlert', { 
  match, 
  signal 
});
```

## é”™è¯¯å¤„ç†

### Promise.allSettled

```typescript
// ç¡®ä¿å•ä¸ªæœåŠ¡å¤±è´¥ä¸å½±å“æ•´ä½“
const [espnResult, polyResult] = await Promise.allSettled([...]);

if (espnResult.status === 'fulfilled') {
  match.espn = espnResult.value;
} else {
  logger.error('ESPN failed', espnResult.reason);
}
```

### æ•°æ®å®Œæ•´æ€§æ ‡è®°

```typescript
dataCompleteness: {
  hasESPNData: boolean,  // æœ‰èƒœç‡å’Œä¼¤ç—…
  hasPolyData: boolean,  // æœ‰å¸‚åœºä»·æ ¼
}

// å‰ç«¯æ ¹æ®æ ‡è®°å†³å®šæ˜¾ç¤ºå†…å®¹
```

## éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Nginx (åå‘ä»£ç†)                   â”‚
â”‚  - é™æ€æ–‡ä»¶ (React æ„å»º)                     â”‚
â”‚  - API è½¬å‘ â†’ Node.js                        â”‚
â”‚  - WebSocket å‡çº§                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚ Node.js  â”‚     â”‚ Node.js  â”‚
    â”‚ Instance â”‚     â”‚ Instance â”‚
    â”‚ (PM2)    â”‚     â”‚ (PM2)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ç›‘æ§æŒ‡æ ‡

- ğŸ“Š æ€»æ¯”èµ›æ•°
- ğŸ“Š å®æ—¶æ¯”èµ›æ•°
- ğŸ“Š å¥—åˆ©ä¿¡å·æ•°
- ğŸ“Š æ•°æ®å®Œæ•´æ€§ç™¾åˆ†æ¯”
- ğŸ“Š API å“åº”æ—¶é—´
- ğŸ“Š WebSocket è¿æ¥æ•°

## ä¸‹ä¸€æ­¥ä¼˜åŒ–

- [ ] æ·»åŠ  Redis åˆ†å¸ƒå¼ç¼“å­˜
- [ ] å®ç°å¤šå®ä¾‹è´Ÿè½½å‡è¡¡
- [ ] æ·»åŠ  Prometheus ç›‘æ§
- [ ] ä¼˜åŒ– WebSocket æ–­çº¿é‡è¿
- [ ] æ·»åŠ æ•°æ®æŒä¹…åŒ–å­˜å‚¨
