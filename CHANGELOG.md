# 📝 PolySniper 更新日志

## [v2.0.2] - 2025-11-25

### 🔄 架构简化

#### 移除WebSocket，仅使用REST API ⚡
- ✅ **完全移除WebSocket代码** - 简化系统架构
  - 删除 `subscribeToRealtimePrices` 相关代码
  - 删除 WebSocket token ID 处理
  - 删除 WebSocket useEffect 钩子
- ✅ **移除市场深度分析** - 简化数据获取
  - 删除 `analyzeMarketDepth` 调用
  - 删除 `analyzeTradingMomentum` 调用
  - 减少API请求数量
- ✅ **仅使用REST API轮询** - 更稳定可靠
  - 价格更新：每45秒
  - 比分更新：每10秒
  - 胜率更新：每45秒

**原因**：
WebSocket连接不稳定，经常出现连接失败和价格不更新的问题。REST API轮询更简单、更可靠。

**效果**：
- 系统更简单，代码更少
- 更稳定，不会出现WebSocket连接问题
- 价格更新延迟45秒（可接受）

---

## [v2.0.1] - 2025-11-25

### 🐛 Bug修复

#### 虎扑比分自动更新优化 ⚡
- ✅ **加快刷新频率** - 从30秒改为10秒
  - 比分更新更及时，无需手动刷新
  - 配合请求队列，安全增加刷新频率
- ✅ **详细的更新日志** - 控制台显示：
  - 每次刷新时显示比赛统计（进行中/已结束/未开始）
  - 实时显示每场进行中比赛的比分和节次
  - 检测到比分变化时显示 "📊 比分已更新！"
- ✅ **智能变化检测** - 只在比分真正变化时提示

**问题背景**：
用户反馈虎扑API的比分没有实时更新，需要手动刷新浏览器。

**解决方案**：
1. 将App.tsx中的轮询间隔从30秒缩短到10秒
2. 添加详细的日志，显示每场比赛的实时比分
3. 智能检测比分变化，避免误报

---

#### WebSocket价格实时显示修复 🔌
- ✅ **直接更新UI** - 收到WebSocket价格立即显示
  - 不再等待market数据重新获取
  - UI更新延迟 < 100ms
- ✅ **异步计算信号** - 信号计算不阻塞UI
  - 价格先显示，信号后更新
  - 用户体验更流畅
- ✅ **增强调试日志** - 详细的WebSocket价格更新日志
  - 显示队伍名、token ID、价格
  - 更容易排查问题

**问题背景**：
用户反馈WebSocket获取的价格没有显示在界面上。

**解决方案**：
1. WebSocket收到价格后直接调用`setPolyData`更新UI
2. 信号计算移到`setTimeout`异步执行
3. 添加详细日志方便调试

---

#### API请求队列和并发控制 🎯
- ✅ **全局请求队列** - 新增 `requestQueue.ts` 服务
  - 限制最多3个并发请求，避免浏览器/代理过载
  - 请求之间延迟200ms，避免瞬时请求过多
  - 自动排队处理，先进先出
- ✅ **所有API使用队列** - `queuedFetch` 替代原生 `fetch`
  - `marketDepth.ts`: fetchOrderBook, fetchSpread, fetchRecentTrades
  - `api.ts`: fetchDailyMatches（虎扑API）
  - `polymarket.ts`: fetchClobPrice, fetchNBAEvents
  - `espn.ts`: fetchNBAGamesByDate, getTeamInjuries, getGameWinProbability
- ✅ **优化轮询策略** - 减少并发请求峰值
  - 初始延迟：0-15秒（原5秒）
  - 轮询间隔：45秒（原30秒）
  - 轮询抖动：额外0-10秒 + 每次0-3秒抖动
  - 避免所有组件同步请求

#### API请求超时和TLS连接错误修复
- ✅ **添加重试机制** - 所有API请求支持最多2次重试
- ✅ **超时控制** - 添加AbortController超时控制
  - 虎扑API: 8秒超时（较慢）
  - Polymarket CLOB API: 5秒超时
  - 市场深度API: 5秒超时
- ✅ **指数退避** - 重试间隔递增（500ms, 1000ms, 1500ms）
- ✅ **更好的错误日志** - 区分超时和网络错误，显示重试次数
- ✅ **Vite代理错误处理** - 添加CLOB代理的超时和错误处理配置

**问题背景**：
用户遇到大量 `Client network socket disconnected before secure TLS connection was established` 错误。这是由于网络不稳定或Clash代理问题导致TLS连接失败。

**解决方案**：
1. 为所有API请求添加超时控制和重试机制
2. 优化Vite代理配置，添加超时和错误处理
3. 请求失败时自动重试，避免页面卡死
4. 使用指数退避策略避免过度重试

#### WebSocket错误处理优化
- ✅ **修复未捕获的Promise错误** - "Uncaught (in promise) Error: disconnected"
  - `initializeWebSocket` 添加 try-catch，不再抛出未捕获错误
  - `ws.onerror` 不再reject Promise，避免页面报错
  - WebSocket断开时优雅降级，不影响REST API功能
- ✅ **改进错误日志** - 更清晰的WebSocket连接状态提示

**问题背景**：
WebSocket连接失败时，Promise错误没有被捕获，导致浏览器控制台出现红色"Uncaught (in promise)"警告，影响用户体验。

**解决方案**：
添加完整的错误处理，确保WebSocket失败时程序继续使用REST API轮询，不会中断。

---

#### 胜率过滤优化
- ✅ **添加买入信号胜率门槛** - 避免推荐弱队买入
  - 强买入：要求赛前胜率 ≥ 50% 或 实时胜率 ≥ 45%
  - 普通买入：要求赛前胜率 ≥ 45% 或 实时胜率 ≥ 40%
  - 修复：之前只要满足价格+分差+时间就会推荐，现在必须有胜率支持
- ✅ **文档更新** - README、PRD、SIGNALS_GUIDE同步更新胜率门槛说明

**问题背景**：
用户反馈骑士队实时胜率只有37%（弱队），但系统仍推荐"买入骑士"。这不符合强队抄底策略，会误导用户买入弱队。

**解决方案**：
在 `strategy.ts` 中添加胜率过滤逻辑，确保只推荐有胜率支持的买入信号。

---

## [v2.0.0] - 2025-11-25

### 🚀 重大更新

#### WebSocket 实时价格推送
- ✅ **浏览器直连** - 不通过Vite代理，直接连接Polymarket WebSocket
- ✅ **官方endpoint** - `wss://ws-subscriptions-clob.polymarket.com/ws/market`
- ✅ **标准消息格式** - `{"type": "market", "assets_ids": [...]}`
- ✅ **PING心跳** - 每10秒保持连接
- ✅ **自动重连** - 连接断开时自动尝试重连（最多5次）
- ✅ **环境变量控制** - `VITE_ENABLE_WEBSOCKET=true/false`
- ✅ **多消息类型支持** - book/price_change/trade
- ✅ **降级到REST API** - WebSocket失败时自动使用REST API轮询

#### 强队抄底策略
- ✅ **赛前胜率判断** - 使用ESPN赛前胜率（> 65%）识别强队
- ✅ **永久缓存** - localStorage持久化赛前胜率，刷新页面不丢失
- ✅ **双显示UI** - 比赛进行中同时显示实时胜率和赛前胜率
- ✅ **智能信号** - 当强队价格低于赛前预期时，即使暂时落后也识别为买入机会
- ✅ **时间因素** - 仅在比赛早期（前3节）执行，控制风险

### 🎨 用户体验优化

#### 提示音控制
- 🔇 **提示音禁用** - 根据用户反馈，关闭交易信号提示音（太吵）
- ✅ **UI显示增强** - 信号卡片高亮显示强信号
- ✅ **控制台日志** - 浏览器控制台打印信号提醒

#### 性能优化
- ✅ **智能延迟** - 随机0-5秒初始延迟，避免所有组件同时请求
- ✅ **降低轮询频率** - REST API轮询从10秒延长到30秒
- ✅ **资源耗尽修复** - 解决 `ERR_INSUFFICIENT_RESOURCES` 错误
- ✅ **App层面优化** - 比赛列表轮询从10秒延长到30秒

### 📊 数据更新

#### ESPN胜率预测
- ✅ **赛前胜率缓存** - localStorage永久保存，刷新页面不丢失
- ✅ **双显示模式** - 赛中同时显示实时胜率和赛前胜率
- ✅ **强队判断基准** - 赛前胜率 > 65% 认定为强队
- ✅ **价格偏离分析** - 对比当前价格与赛前预期

#### 数据源频率
- WebSocket: < 1秒（实时推送）
- REST API: 30秒（比赛进行中），120秒（未开始）
- 比赛列表: 30秒
- ESPN胜率: 按需更新，赛前数据永久缓存

### 📖 文档完善

#### 新增文档
- ✅ **WEBSOCKET_STATUS.md** - WebSocket实现状态详解
- ✅ **DOCS_INDEX.md** - 文档索引总览

#### 更新文档
- ✅ **README.md** - 添加WebSocket、强队抄底策略说明
- ✅ **SIGNALS_GUIDE.md** - 强队抄底策略详解，提示音状态更新
- ✅ **PRD.md** - WebSocket方案、赛前胜率缓存功能

### 🐛 Bug修复

#### WebSocket连接
- ✅ 移除Vite代理，改为浏览器直连（避免代理配置问题）
- ✅ 修正订阅消息格式（使用官方 `assets_ids` 字段）
- ✅ 添加PING心跳保持连接
- ✅ 增强消息处理，支持多种消息类型

#### 资源耗尽
- ✅ 修复多个组件同时请求导致的 `ERR_INSUFFICIENT_RESOURCES`
- ✅ 添加随机延迟机制
- ✅ 降低轮询频率

#### 赛前胜率丢失
- ✅ 修复比赛开始后赛前胜率被实时胜率覆盖的问题
- ✅ 使用localStorage持久化缓存
- ✅ 确保刷新页面后数据不丢失

---

## [v1.0.0] - 2025-11-20（假设日期）

### 🎉 首次发布

#### 核心功能
- ✅ Polymarket价格监控（REST API轮询）
- ✅ 虎扑比赛数据获取
- ✅ ESPN胜率预测
- ✅ 交易策略信号生成
- ✅ 比赛卡片UI
- ✅ 信号历史记录
- ✅ 价格趋势图

#### 交易策略
- ✅ 均值回归策略
- ✅ 波段交易策略
- ✅ 买入/卖出信号
- ✅ 置信度评分

#### 提示系统
- ✅ 强买入/强卖出提示音
- ✅ 信号卡片显示

---

## 版本对比

| 功能 | v1.0.0 | v2.0.0 |
|------|--------|--------|
| **价格更新** | REST API 10秒 | WebSocket < 1秒 + REST API 30秒 |
| **核心策略** | 均值回归 | 强队抄底 + 均值回归 |
| **赛前胜率** | 不缓存 | localStorage永久缓存 ✅ |
| **胜率显示** | 单显示 | 双显示（实时+赛前）✅ |
| **提示音** | 启用 | 禁用（用户反馈太吵）🔇 |
| **资源优化** | 无 | 智能延迟 + 降频 ✅ |
| **WebSocket** | 未实现 | 浏览器直连 ✅ |
| **文档** | 基础 | 完整索引体系 ✅ |

---

## 下一步计划

### 🔮 未来版本（v2.1.0+）

#### WebSocket优化
- [ ] 连接池管理 - 多个组件共享单个WebSocket连接
- [ ] 消息队列 - 缓冲价格更新，批量处理
- [ ] 智能重连 - 根据网络状况调整重连策略
- [ ] 备选endpoint - 尝试 `wss://ws-live-data.polymarket.com`

#### 策略增强
- [ ] 动态阈值调整 - 根据历史数据优化买入/卖出阈值
- [ ] 多市场支持 - 支持其他体育项目（NFL、MLB等）
- [ ] 回测系统 - 历史数据回测策略有效性
- [ ] 机器学习 - 使用ML模型优化信号生成

#### 用户体验
- [ ] 自定义提示音 - 允许用户选择是否启用、选择音效
- [ ] 暗黑模式 - 支持深色主题
- [ ] 移动端适配 - 响应式设计优化
- [ ] 快捷操作 - 一键买入/卖出（需集成Polymarket API）

#### 数据分析
- [ ] 胜率统计 - 记录信号准确率
- [ ] 收益追踪 - 模拟交易收益计算
- [ ] 市场分析 - 价格波动分析、流动性监控
- [ ] 导出报告 - 交易日志导出为CSV/Excel

---

## 技术债务

### 已知问题
- [ ] WebSocket连接需要代理才能访问（某些地区）
- [ ] 单个MatchCard独立订阅WebSocket（可优化为共享连接）
- [ ] 不支持WebSocket历史数据回放
- [ ] IE浏览器不支持（依赖WebSocket API）

### 待优化
- [ ] Redux迁移 - 考虑从Context API迁移到Redux Toolkit
- [ ] 单元测试 - 添加核心逻辑单元测试
- [ ] E2E测试 - Playwright自动化测试
- [ ] 性能监控 - 添加性能指标收集

---

## 贡献者

感谢所有为 PolySniper 项目做出贡献的开发者！

---

## 许可证

MIT License

---

📅 最后更新：2025-11-25  
📝 文档版本：v2.0.0
