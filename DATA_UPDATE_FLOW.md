# ğŸ”„ æ•°æ®æ›´æ–°æµç¨‹è¯´æ˜

## ğŸ“Š æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åç«¯å®šæ—¶è½®è¯¢                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚      Data Aggregator (æ¯ 5 ç§’)               â”‚      â”‚
â”‚  â”‚                                               â”‚      â”‚
â”‚  â”‚  1. è·å–æœªæ¥ 3 å¤©çš„æ¯”èµ›                       â”‚      â”‚
â”‚  â”‚  2. è¿‡æ»¤å·²ç»“æŸçš„æ¯”èµ›                          â”‚      â”‚
â”‚  â”‚  3. å¯¹æ¯åœºæ¯”èµ›è·å–è¯¦ç»†æ•°æ®:                   â”‚      â”‚
â”‚  â”‚     - ESPN èƒœç‡ + ä¼¤ç—…                        â”‚      â”‚
â”‚  â”‚     - Polymarket ä»·æ ¼                         â”‚      â”‚
â”‚  â”‚  4. è®¡ç®—å¥—åˆ©ä¿¡å·                              â”‚      â”‚
â”‚  â”‚  5. æ›´æ–°å†…å­˜ç¼“å­˜                              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                     â”‚                                   â”‚
â”‚                     â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚    WebSocket Server (æ¯ 3 ç§’)                â”‚      â”‚
â”‚  â”‚                                               â”‚      â”‚
â”‚  â”‚  1. ä» Data Aggregator è¯»å–æœ€æ–°æ•°æ®          â”‚      â”‚
â”‚  â”‚  2. æ¨é€ç»™æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯                    â”‚      â”‚
â”‚  â”‚  3. å¦‚æœ‰å¥—åˆ©ä¿¡å·ï¼Œç«‹å³å‘é€å‘Šè­¦                â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ WebSocket (æ¨é€)
                     â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚    å‰ç«¯ React        â”‚
          â”‚                      â”‚
          â”‚  1. æ¥æ”¶ WebSocket   â”‚
          â”‚  2. æ›´æ–° UI          â”‚
          â”‚  3. æ— éœ€è½®è¯¢         â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## â±ï¸ å®šæ—¶å™¨è¯¦è§£

### 1ï¸âƒ£ åç«¯æ•°æ®é‡‡é›† (Data Aggregator)

**é¢‘ç‡**: æ¯ **5 ç§’**

**ä»£ç ä½ç½®**: `server/src/services/dataAggregator.ts`

```typescript
// å¯åŠ¨æ—¶è®¾ç½®å®šæ—¶å™¨
this.updateInterval = setInterval(() => {
  this.updateAllMatches().catch(err => {
    logger.error('æ›´æ–°æ¯”èµ›æ•°æ®å¤±è´¥:', err);
  });
}, 5000); // 5ç§’
```

**æ‰§è¡Œæµç¨‹**:
```
æ¯ 5 ç§’æ‰§è¡Œä¸€æ¬¡:
â”œâ”€ 1. è·å–ä»Šå¤©ã€æ˜å¤©ã€åå¤©çš„æ¯”èµ› (å¹¶è¡Œè¯·æ±‚)
â”‚   â”œâ”€ ESPN Scoreboard API (20251220)
â”‚   â”œâ”€ ESPN Scoreboard API (20251221)
â”‚   â””â”€ ESPN Scoreboard API (20251222)
â”‚
â”œâ”€ 2. åˆå¹¶å¹¶è¿‡æ»¤æ¯”èµ›
â”‚   â””â”€ è¿‡æ»¤æ‰ status === 'post' (å·²ç»“æŸ)
â”‚
â”œâ”€ 3. éå†æ¯åœºæ¯”èµ› (ä¸²è¡Œ)
â”‚   â””â”€ å¹¶è¡Œè¯·æ±‚:
â”‚       â”œâ”€ ESPN Summary API â†’ èƒœç‡ + ä¼¤ç—…
â”‚       â””â”€ Polymarket Events API â†’ ä»·æ ¼
â”‚
â”œâ”€ 4. è®¡ç®—å¥—åˆ©ä¿¡å·
â”‚   â””â”€ arbitrageEngine.calculateSignals()
â”‚
â””â”€ 5. ä¿å­˜åˆ°å†…å­˜ Map
    â””â”€ this.matches.set(matchId, match)
```

### 2ï¸âƒ£ WebSocket æ¨é€ (WebSocket Server)

**é¢‘ç‡**: æ¯ **3 ç§’**

**ä»£ç ä½ç½®**: `server/src/websocket/index.ts`

```typescript
// å¯åŠ¨æ—¶è®¾ç½®å®šæ—¶å™¨
this.updateInterval = setInterval(() => {
  this.broadcastUpdates();
}, 3000); // 3ç§’
```

**æ‰§è¡Œæµç¨‹**:
```
æ¯ 3 ç§’æ‰§è¡Œä¸€æ¬¡:
â”œâ”€ 1. ä» DataAggregator è¯»å–æœ€æ–°æ•°æ®
â”‚   â””â”€ dataAggregator.getAllMatches()
â”‚
â”œâ”€ 2. å¹¿æ’­ç»™æ‰€æœ‰è®¢é˜…çš„å®¢æˆ·ç«¯
â”‚   â”œâ”€ è®¢é˜…æ‰€æœ‰æ¯”èµ› ('all-matches') â†’ å‘é€å…¨éƒ¨æ•°æ®
â”‚   â””â”€ è®¢é˜…ç‰¹å®šæ¯”èµ› ('match:xxx') â†’ å‘é€å•åœºæ•°æ®
â”‚
â””â”€ 3. æ£€æµ‹å¥—åˆ©ä¿¡å·
    â””â”€ å¦‚æœæœ‰ä¿¡å· â†’ ç«‹å³å‘é€ 'signalAlert'
```

### 3ï¸âƒ£ å‰ç«¯æ¥æ”¶ (React)

**é¢‘ç‡**: **å®æ—¶** (è¢«åŠ¨æ¥æ”¶ WebSocket æ¨é€)

**ä»£ç ä½ç½®**: `client/src/services/websocket.ts`

```typescript
// ç›‘å¬ WebSocket äº‹ä»¶
socket.on('matchesUpdate', (data) => {
  // æ›´æ–° UI
  updateMatches(data.data);
});

socket.on('signalAlert', (data) => {
  // æ˜¾ç¤ºå¥—åˆ©å‘Šè­¦
  showAlert(data.signals);
});
```

## ğŸ“ˆ æ•°æ®æµæ—¶é—´çº¿

```
T=0s   åç«¯å¯åŠ¨ â†’ ç«‹å³è·å–æ•°æ®
       â†“
T=0s   é¦–æ¬¡æ•°æ®æ¨é€ç»™æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯
       â†“
T=3s   WebSocket æ¨é€ç¬¬1æ¬¡æ›´æ–°
       â†“
T=5s   åç«¯ç¬¬2æ¬¡é‡‡é›†æ•°æ®
       â†“
T=6s   WebSocket æ¨é€ç¬¬2æ¬¡æ›´æ–°
       â†“
T=9s   WebSocket æ¨é€ç¬¬3æ¬¡æ›´æ–°
       â†“
T=10s  åç«¯ç¬¬3æ¬¡é‡‡é›†æ•°æ®
       â†“
...    å¾ªç¯å¾€å¤
```

## ğŸ” è¯¦ç»†è¯´æ˜

### åç«¯é‡‡é›† (5ç§’)

#### ä¸ºä»€ä¹ˆæ˜¯ 5 ç§’ï¼Ÿ

âœ… **ä¼˜ç‚¹**:
- å¯¹ ESPN API å‹å¥½ï¼ˆé¿å…é¢‘ç¹è¯·æ±‚ï¼‰
- ä¿è¯æ•°æ®æ–°é²œåº¦
- å‡å°‘æœåŠ¡å™¨è´Ÿè½½

âŒ **ç¼ºç‚¹**:
- æ¯”èµ›å…³é”®æ—¶åˆ»å¯èƒ½æœ‰ 5 ç§’å»¶è¿Ÿ

#### ä¼˜åŒ–ç­–ç•¥

```typescript
// å¯ä»¥åŠ¨æ€è°ƒæ•´é¢‘ç‡
const updateFrequency = match.status === 'LIVE' 
  ? 3000  // ç›´æ’­ä¸­ï¼š3ç§’
  : 10000; // æœªå¼€å§‹ï¼š10ç§’
```

### WebSocket æ¨é€ (3ç§’)

#### ä¸ºä»€ä¹ˆæ˜¯ 3 ç§’ï¼Ÿ

âœ… **ä¼˜ç‚¹**:
- æ¯”åç«¯é‡‡é›†å¿«ï¼Œç¡®ä¿å®¢æˆ·ç«¯çœ‹åˆ°æœ€æ–°æ•°æ®
- è¶³å¤Ÿå®æ—¶
- ä¸ä¼šè¿‡åº¦æ¶ˆè€—å¸¦å®½

âŒ **ç¼ºç‚¹**:
- å³ä½¿æ•°æ®æœªå˜åŒ–ä¹Ÿä¼šæ¨é€

#### ä¼˜åŒ–ç­–ç•¥

```typescript
// åªåœ¨æ•°æ®å˜åŒ–æ—¶æ¨é€
if (hasDataChanged(oldMatches, newMatches)) {
  this.io.emit('matchesUpdate', newMatches);
}
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰å€¼ | è¯´æ˜ |
|------|-------|------|
| åç«¯é‡‡é›†å‘¨æœŸ | 5 ç§’ | è·å– ESPN + Polymarket æ•°æ® |
| WebSocket æ¨é€ | 3 ç§’ | æ¨é€ç»™å‰ç«¯ |
| å•æ¬¡é‡‡é›†æ—¶é—´ | ~1-2 ç§’ | 5åœºæ¯”èµ›å¹¶è¡Œå¤„ç† |
| å‰ç«¯æ›´æ–°å»¶è¿Ÿ | 0-8 ç§’ | æœ€åæƒ…å†µï¼š5ç§’é‡‡é›† + 3ç§’æ¨é€ |

## ğŸ¯ èµ„æºæ¶ˆè€—

### API è°ƒç”¨é¢‘ç‡

**ESPN API**:
```
æ¯ 5 ç§’:
â”œâ”€ Scoreboard Ã— 3 = 3 æ¬¡/5ç§’ = 36 æ¬¡/åˆ†é’Ÿ
â””â”€ Summary Ã— Nåœºæ¯”èµ› = ~5 æ¬¡/5ç§’ = 60 æ¬¡/åˆ†é’Ÿ

æ€»è®¡: ~100 æ¬¡/åˆ†é’Ÿ
```

**Polymarket API**:
```
æ¯ 5 ç§’:
â””â”€ Events Ã— Nåœºæ¯”èµ› = ~5 æ¬¡/5ç§’ = 60 æ¬¡/åˆ†é’Ÿ
```

### WebSocket å¸¦å®½

```
æ¯ 3 ç§’æ¨é€:
â”œâ”€ å•æ¬¡æ•°æ®åŒ…: ~50KB (5åœºæ¯”èµ›)
â””â”€ æ¯åˆ†é’Ÿæµé‡: ~1MB

å•ä¸ªå®¢æˆ·ç«¯æ¯å°æ—¶: ~60MB
10ä¸ªå®¢æˆ·ç«¯æ¯å°æ—¶: ~600MB
```

## ğŸ”§ å¯é…ç½®é€‰é¡¹

### ç¯å¢ƒå˜é‡æ”¯æŒ (å»ºè®®æ·»åŠ )

```bash
# åç«¯é‡‡é›†é¢‘ç‡ï¼ˆæ¯«ç§’ï¼‰
DATA_FETCH_INTERVAL=5000

# WebSocket æ¨é€é¢‘ç‡ï¼ˆæ¯«ç§’ï¼‰
WS_BROADCAST_INTERVAL=3000

# æ˜¯å¦åªåœ¨æ•°æ®å˜åŒ–æ—¶æ¨é€
WS_PUSH_ON_CHANGE=true
```

### ä»£ç å®ç°

```typescript
// config/index.ts
export const config = {
  dataFetchInterval: process.env.DATA_FETCH_INTERVAL || 5000,
  wsBroadcastInterval: process.env.WS_BROADCAST_INTERVAL || 3000,
  wsPushOnChange: process.env.WS_PUSH_ON_CHANGE === 'true',
};
```

## ğŸš€ ä¼˜åŒ–å»ºè®®

### 1. å¢é‡æ›´æ–°

**å½“å‰**: æ¯æ¬¡æ¨é€å…¨éƒ¨æ•°æ®

**ä¼˜åŒ–**: åªæ¨é€å˜åŒ–çš„æ¯”èµ›

```typescript
// è®¡ç®—æ•°æ®å·®å¼‚
const changedMatches = matches.filter(match => {
  const old = this.previousMatches.get(match.id);
  return !old || hasChanged(old, match);
});

// åªæ¨é€å˜åŒ–
if (changedMatches.length > 0) {
  this.io.emit('matchesUpdate', {
    type: 'incremental',
    data: changedMatches,
  });
}
```

### 2. åŠ¨æ€é¢‘ç‡è°ƒæ•´

```typescript
// æ ¹æ®æ¯”èµ›çŠ¶æ€è°ƒæ•´
private getUpdateInterval(match: UnifiedMatch): number {
  switch (match.status) {
    case 'LIVE': return 3000;   // ç›´æ’­ä¸­: 3ç§’
    case 'PRE': return 10000;   // æœªå¼€å§‹: 10ç§’
    case 'FINAL': return 0;     // å·²ç»“æŸ: ä¸æ›´æ–°
  }
}
```

### 3. WebSocket æˆ¿é—´ä¼˜åŒ–

```typescript
// åªå‘éœ€è¦çš„å®¢æˆ·ç«¯æ¨é€
socket.join(`status:${match.status}`);

// ç›´æ’­æ¯”èµ›é¢‘ç¹æ¨é€
this.io.to('status:LIVE').emit('matchesUpdate', liveMatches);

// æœªå¼€å§‹çš„æ¯”èµ›æ…¢é€Ÿæ¨é€
this.io.to('status:PRE').emit('matchesUpdate', preMatches);
```

## ğŸ› å·²çŸ¥é—®é¢˜

1. **é‡å¤æ¨é€**
   - WebSocket æ¯ 3 ç§’æ¨é€ï¼Œå³ä½¿æ•°æ®æœªå˜åŒ–
   - **è§£å†³**: æ·»åŠ æ•°æ®æ¯”å¯¹é€»è¾‘

2. **å†—ä½™æ•°æ®**
   - æ¯æ¬¡æ¨é€å…¨éƒ¨æ¯”èµ›æ•°æ®
   - **è§£å†³**: å®ç°å¢é‡æ›´æ–°

3. **æ— å·®å¼‚åŒ–æ›´æ–°**
   - æ‰€æœ‰æ¯”èµ›ä½¿ç”¨ç›¸åŒé¢‘ç‡
   - **è§£å†³**: æ ¹æ®çŠ¶æ€åŠ¨æ€è°ƒæ•´

## ğŸ“ æ€»ç»“

å½“å‰æ¶æ„é‡‡ç”¨ **åŒå®šæ—¶å™¨** è®¾è®¡ï¼š

1. **åç«¯é‡‡é›† (5ç§’)** - ä» ESPN/Polymarket è·å–æ•°æ®
2. **WebSocket æ¨é€ (3ç§’)** - æ¨é€ç»™å‰ç«¯

è¿™ç§è®¾è®¡ç®€å•å¯é ï¼Œä½†æœ‰ä¼˜åŒ–ç©ºé—´ï¼š
- âœ… å®æ—¶æ€§è¾ƒå¥½
- âœ… å®ç°ç®€å•
- âŒ å­˜åœ¨å†—ä½™æ¨é€
- âŒ æœªæ ¹æ®çŠ¶æ€å·®å¼‚åŒ–å¤„ç†

å»ºè®®æ ¹æ®å®é™…è´Ÿè½½å’Œéœ€æ±‚è¿›è¡Œä¼˜åŒ–è°ƒæ•´ã€‚
