# 虎扑 API 性能优化说明

## 优化目标

根据测试数据，虎扑接口的主要瓶颈在于连接建立耗时（约 0.568s），而非服务器处理速度（约 0.211s）。通过启用 HTTP Keep-Alive 连接复用，可以将每次请求的实际耗时从约 0.896s 降低到约 0.3s 左右。

## 优化内容

### 1. 后端代理优化 - HTTP Keep-Alive 连接复用

**文件**: `api/hupu/[...path].ts`

#### 实现细节

- **创建全局 HTTPS Agent**: 在 Serverless Function 中创建全局的 `https.Agent` 实例
- **Keep-Alive 配置**:
  - `keepAlive: true` - 启用连接复用
  - `keepAliveMsecs: 30000` - 连接空闲保持 30 秒
  - `maxSockets: 10` - 最多 10 个并发连接
  - `maxFreeSockets: 5` - 最多保持 5 个空闲连接
  - `scheduling: 'lifo'` - 优先复用最近使用的连接

#### 预期效果

- **首次请求**: 约 0.896s（需要建立连接）
- **后续请求**: 约 0.3s（复用已有连接，跳过 TCP/SSL 握手）
- **连接建立开销降低**: 从 0.568s 降至接近 0

#### 技术原理

在 Serverless 环境中，同一容器实例内的多次请求可以共享全局的 Agent 对象。当 Agent 启用 Keep-Alive 时：
1. 第一次请求建立 TCP/SSL 连接
2. 连接在请求结束后不会立即关闭，而是保持在空闲连接池中
3. 后续请求直接复用空闲连接，跳过耗时的握手过程

### 2. 前端轮询频率优化

**文件**: `src/App.tsx`

#### 调整内容

- **原频率**: 10 秒/次
- **新频率**: 5 秒/次
- **安全性考虑**: 5 秒是在速度和安全性之间的平衡点，避免触发虎扑 API 的频率限制

#### 频率选择建议

| 更新频率 | 适用场景 | 风险等级 |
|---------|---------|---------|
| 10 秒 | 保守策略 | ✅ 低 |
| 5 秒 | **推荐** - 平衡速度和安全 | ⚠️ 中低 |
| 3 秒 | 比赛高峰期 | ⚠️ 中 |
| 1-2 秒 | 激进策略 | ❌ 高（可能被封禁） |

### 3. 性能监控日志

**文件**: `src/services/api.ts`, `api/hupu/[...path].ts`

#### 监控指标

- **前端监控**: 总耗时（从发起请求到解析完成）
- **后端监控**: 
  - 连接耗时（到收到响应头）
  - 解析耗时（JSON 解析）
  - 总耗时

#### 日志示例

```
前端:
[虎扑API] ✅ 342ms - 获取 12 场比赛 (进行中:3 已结束:5 未开始:4)

后端:
✅ [Hupu Proxy] Success - Total: 312ms, Connection: 243ms, Parse: 69ms
🔌 [Keep-Alive] Free sockets: 2
```

## 实际效果监控

### 优化前（无 Keep-Alive）

```
请求 1: ~896ms (建立连接 ~568ms)
请求 2: ~896ms (建立连接 ~568ms) 
请求 3: ~896ms (建立连接 ~568ms)
```

### 优化后（启用 Keep-Alive）

```
请求 1: ~896ms (建立连接 ~568ms) ← 首次连接
请求 2: ~300ms (复用连接 ~0ms)    ← 性能提升 66%
请求 3: ~300ms (复用连接 ~0ms)    ← 性能提升 66%
```

## 风险控制

### 1. 频率限制风险

虎扑 API 是非官方接口，存在被限速的风险：

- **缓解措施**:
  - 从 5 秒开始测试，观察稳定性
  - 监控错误率和响应时间
  - 如有异常，立即回退到 10 秒频率

### 2. Serverless 冷启动

Vercel 的 Serverless Function 在冷启动时会创建新容器：

- **影响**: 冷启动的第一个请求仍需建立新连接（~896ms）
- **后续请求**: 在同一容器内可以复用连接（~300ms）
- **缓解**: Vercel 会根据流量自动保持热容器

### 3. 连接池管理

- **自动清理**: Agent 会自动清理过期连接
- **手动监控**: 每分钟输出连接池状态日志
- **资源限制**: 最多保持 5 个空闲连接，避免资源浪费

## 测试建议

### 阶段 1: 验证 Keep-Alive 效果

1. 部署更新后，观察日志中的耗时变化
2. 预期看到：首次请求 ~800ms，后续请求 ~300ms
3. 检查 `[Keep-Alive] Free sockets` 日志，确认连接被复用

### 阶段 2: 测试新频率的稳定性

1. **第 1 天**: 使用 5 秒频率，监控 24 小时
2. **观察指标**:
   - 错误率是否正常（< 1%）
   - 是否出现 429 (Too Many Requests) 或 403 (Forbidden)
   - 平均响应时间是否稳定
3. **如有异常**: 立即回退到 10 秒

### 阶段 3: （可选）激进优化

如果 5 秒频率稳定运行 3 天以上，可尝试：
- 调整为 3 秒（仅在比赛进行中）
- 密切监控一周
- 如有问题立即回退

## 回退方案

如果遇到问题，可以快速回退：

### 回退到原始配置

```typescript
// api/hupu/[...path].ts
// 移除 httpsAgent，使用默认 fetch
const response = await fetch(targetUrl, {
  method: req.method,
  headers: {
    'User-Agent': 'Mozilla/5.0...',
    'Accept': 'application/json',
  },
});

// src/App.tsx
// 恢复 10 秒轮询
}, 10000);
```

## 技术参考

- **HTTP Keep-Alive**: [RFC 2616 - Section 8.1](https://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html)
- **Node.js Agent**: [官方文档](https://nodejs.org/api/http.html#class-httpagent)
- **Vercel Serverless**: [函数执行环境](https://vercel.com/docs/functions/serverless-functions)

## 总结

通过启用 HTTP Keep-Alive 连接复用，可以将虎扑 API 的响应速度提升约 **66%**（从 ~896ms 降至 ~300ms），从而支持更高的更新频率（5 秒）。这将显著提升用户体验，使比分更新更及时。

关键是要在速度和安全性之间找到平衡，避免因过于频繁的请求而被虎扑 API 限速或封禁。建议从 5 秒开始，根据实际运行情况逐步优化。
