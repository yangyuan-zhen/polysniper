# 📋 PolySniper - 产品需求文档 (PRD)

## 1. 产品概述

### 1.1 产品定位
PolySniper 是一个面向 Polymarket NBA 预测市场的实时监控与智能交易辅助系统，通过整合多源数据（价格、比分、胜率、伤病）提供高置信度的交易信号。

### 1.2 目标用户
- 活跃的 Polymarket NBA 市场交易者
- 需要实时数据监控的量化交易者
- 寻求套利机会的投资者

### 1.3 核心价值
- **实时性**：
  - WebSocket直连 < 1秒实时推送（可选）
  - REST API 30秒轮询备份
  - 智能延迟避免资源耗尽
- **智能化**：
  - 强队抄底策略（基于赛前ESPN胜率）
  - 多因素信号生成（价格+比分+时间+胜率）
- **完整性**：比赛数据、价格、胜率、伤病一站式查看

---

## 2. 核心功能需求

### 2.1 实时数据监控

#### 2.1.1 Polymarket 价格监控
**优先级**：P0  
**实现方式**：
- **WebSocket实时推送**：< 1秒延迟（主要更新方式）
  - 官方endpoint: `wss://ws-subscriptions-clob.polymarket.com/ws/market`
  - 浏览器直连，不通过Vite代理
  - 订阅消息: `{"type": "market", "assets_ids": [...]}`
  - PING心跳：每10秒保持连接
- **REST API轮询**：30秒（备份方式）
  - 随机延迟0-5秒避免并发
  - 比赛进行中30秒，未开始120秒

**数据字段**：
- `homePrice`: 主队价格（0-1）
- `awayPrice`: 客队价格（0-1）
- `volume`: 交易量
- `liquidity`: 流动性

**环境变量控制**：
```bash
VITE_ENABLE_WEBSOCKET=true  # true/false
```

#### 2.1.2 比赛实时比分
**优先级**：P0  
**数据源**：虎扑 API  
**更新频率**：30秒（App层面），单个MatchCard独立轮询

**数据字段**：
- 比分（主队/客队）
- 当前节数（1-4）
- 剩余时间
- 比赛状态（未开始/进行中/结束）

#### 2.1.3 ESPN 胜率预测 ⭐ （核心功能）
**优先级**：P0  
**实现方式**：
- **赛前胜率**：从 ESPN BET赔率计算
  - 公式：负赔率 = |odds| / (|odds| + 100)
  - 公式：正赔率 = 100 / (odds + 100)
  - **永久缓存**：localStorage持久化，刷新页面不丢失
  - **关键作用**：作为强队判断基准（> 65%）
- **赛中胜率**：ESPN Win Probability API 实时更新
  - 动态胜率，反映当前比赛局势
  - 与Polymarket价格对比，识别价格偏离

**UI显示**：
- 赛前：显示赛前胜率
- 赛中：同时显示实时胜率和赛前胜率（双显示）

**应用场景**：
- 强队判断：赛前胜率 > 65% → 确认为强队
- 价格对比：当前价格 vs 赛前预期
- 提高信号置信度：结合比分+价格+胜率

#### 2.1.4 伤病信息
**优先级**：P2  
**数据源**：ESPN Injuries API  
**展示方式**：球队信息弹窗

---

### 2.2 交易策略信号

#### 2.2.1 信号类型

**强买入 (STRONG_BUY) - 强队抄底**
- 核心策略：识别赛前强队的暂时价格低估机会
- 触发条件：
  1. **赛前判断**：ESPN赛前胜率 ≥ 55%（确认为强队）
  2. **价格低估**：当前价格 < 赛前胜率 - 10%
  3. **比分可接受**：暂时落后 < 10分 或 领先
  4. **时间充裕**：比赛早期（前3节）
  5. **胜率支持**：赛前 ≥ 50% 或 实时 ≥ 45%
  6. **置信度**：≥ 70%
- 提示音：已禁用（静音模式）

**买入 (BUY)**
- 触发条件：
  - 价格 35¢ - 45¢ + 小幅落后
  - 但不满足强队抄底条件
  - **胜率支持**：赛前 ≥ 45% 或 实时 ≥ 40%
- 置信度：50-70%
- 提示音：无

**强卖出 (STRONG_SELL) - 领先套现**
- 触发条件：
  1. 价格高位：≥ 75¢
  2. 比分优势：大幅领先（≥ 8分）
  3. 置信度：≥ 70%
- 提示音：已禁用（静音模式）

**卖出 (SELL)**
- 触发条件：价格 ≥ 65¢ + 领先
- 置信度：50-70%
- 提示音：无

**中性 (NEUTRAL)**
- 不符合任何交易条件

#### 2.2.2 策略算法

**核心逻辑**：
1. **强队抄底策略** (Strong Team Dip Buying)
   - 利用赛前胜率判断真实实力
   - 在强队暂时落后时抓住抄底机会
   - 不盲目抓弱队反弹
2. **均值回归** (Mean Reversion)
   - 价格偏离真实胜率时会回归
3. **波段交易** (Swing Trading)
   - 捕捉比赛中的价格波动

**考虑因素**：
1. **价格因素** (40%)
   - 价格区间
   - 历史价格波动
2. **比分因素** (30%)
   - 当前分差
   - 节数进度
3. **时间因素** (20%)
   - 剩余时间
   - 比赛阶段
4. **ESPN 胜率** (10%)
   - 实时胜率 vs 市场价格
   - 偏差度分析

**置信度计算**：
```typescript
confidence = (
  priceConfidence * 0.4 +
  scoreConfidence * 0.3 +
  timeConfidence * 0.2 +
  espnConfidence * 0.1
) * 100
```

---

### 2.3 数据可视化

#### 2.3.1 比赛卡片
**布局**：
- 顶部：球队名称、比分
- 中部：价格显示（主队/客队）
- 底部：交易信号、置信度

**颜色编码**：
- 🟢 绿色：主队价格 ≥ 60¢
- 🔴 红色：主队价格 ≤ 40¢
- ⚪ 灰色：价格 40-60¢

#### 2.3.2 价格趋势图
**图表类型**：折线图（Chart.js）  
**功能**：
- 切换主队/客队视图
- 显示信号标记点
- 鼠标悬停查看详情

#### 2.3.3 信号历史
**展示内容**：
- 时间戳
- 比赛信息
- 信号类型
- 价格快照
- 置信度

---

## 3. 技术架构

### 3.1 前端技术栈
- **框架**：React 18 + TypeScript
- **构建工具**：Vite
- **状态管理**：Redux Toolkit
- **样式**：TailwindCSS
- **图表**：Chart.js + react-chartjs-2
- **图标**：Lucide React

### 3.2 数据接口

#### Polymarket API
- **HTTP API**：`/clob/events?market=nba` 
- **更新频率**：10秒轮询
- **代理需求**：需要 VPN/Clash

#### 虎扑 API
- **Endpoint**：`/api/hupu/1/7.5.60/basketballapi/scheduleList`
- **代理需求**：Vite 代理到 `https://games.mobileapi.hupu.com`

#### ESPN API
- **Scoreboard**：`site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard`
- **Summary**：`site.api.espn.com/apis/site/v2/sports/basketball/nba/summary?event={gameId}`
- **Injuries**：`site.api.espn.com/apis/site/v2/sports/basketball/nba/teams/{teamId}`

---

## 4. 用户交互流程

### 4.1 首次加载
1. 获取今日比赛列表（虎扑 API）
2. 匹配 Polymarket 市场数据
3. 启动定时轮询（每 10 秒刷新）

### 4.2 实时监控
1. 每 10 秒自动刷新价格和比分 → 更新 UI
2. 重新计算策略信号
3. 触发强信号 → 播放提示音 → 显示通知

### 4.3 用户操作
1. **查看比赛详情**：点击卡片 → 打开价格趋势图
2. **查看球队信息**：点击球队名 → 打开伤病信息弹窗
3. **筛选比赛**：按钮切换（全部/进行中/未开始/已结束）
4. **查看信号历史**：底部信号列表滚动查看

---

## 5. 性能要求

### 5.1 响应时间
- 数据刷新延迟：10秒
- UI 渲染刷新：< 50ms
- 策略计算耗时：< 10ms

### 5.2 资源占用
- 内存占用：< 200MB
- CPU 占用：< 5%（空闲时）
- 网络带宽：< 1Mbps

---

## 6. 风险与限制

### 6.1 技术风险
- **API 限流**：Polymarket 可能限制请求频率
- **数据延迟**：10秒刷新间隔，可能错过快速价格变化
- **网络稳定性**：VPN 断连导致数据无法更新

### 6.2 交易风险
- **信号滞后**：价格变化比信号生成快
- **流动性不足**：小市场可能无法成交
- **黑天鹅事件**：伤病、裁判误判等

### 6.3 合规风险
- 预测市场在部分地区可能受限
- 需要用户自行承担法律责任

---

## 7. 未来规划

### 7.1 短期（1-3个月）
- [ ] 添加更多运动项目（NFL、足球）
- [ ] 优化策略算法（机器学习）
- [ ] 移动端适配

### 7.2 中期（3-6个月）
- [ ] 自动化交易（通过 Polymarket API）
- [ ] 回测系统（历史数据验证策略）
- [ ] 社区信号分享

### 7.3 长期（6-12个月）
- [ ] 多账户管理
- [ ] 风险管理工具
- [ ] 实时聊天室

---

## 8. 版本历史

### v1.0.0 (当前版本)
- ✅ HTTP 轮询实时数据更新（10秒）
- ✅ 基础交易策略信号
- ✅ 比赛数据监控
- ✅ 价格趋势图
- ✅ 伤病信息查询
- ✅ ESPN 赛前/赛中胜率预测

---

## 9. 参考资料

- [Polymarket CLOB API 文档](https://docs.polymarket.com)
- [ESPN 隐藏 API](https://gist.github.com/akeaswaran/b48b02f1c94f873c6655e7129910fc3b)
- [虎扑移动 API](https://games.mobileapi.hupu.com)
