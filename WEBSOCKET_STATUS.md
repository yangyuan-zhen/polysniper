# ğŸ“¡ WebSocket å®æ—¶ä»·æ ¼æ›´æ–° - å®ç°çŠ¶æ€

## ğŸ¯ å½“å‰çŠ¶æ€

**WebSocketåŠŸèƒ½**ï¼šâœ… å·²å®ç°ï¼Œå¯é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶

## ğŸ“Š å®ç°æ–¹æ¡ˆ

### æ¶æ„è®¾è®¡

```
æµè§ˆå™¨ --ç›´è¿--> Polymarket WebSocket
   â†“                      â†“
ä»·æ ¼æ›´æ–°å›è°ƒ       è®¢å•ç°¿/äº¤æ˜“/ä»·æ ¼å˜åŒ–
   â†“
MatchCardç»„ä»¶æ›´æ–°
```

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… **æµè§ˆå™¨ç›´è¿** - ä¸é€šè¿‡Viteä»£ç†ï¼ˆWebSocketä¸å—CORSé™åˆ¶ï¼‰
- âœ… **å®˜æ–¹endpoint** - `wss://ws-subscriptions-clob.polymarket.com/ws/market`
- âœ… **æ ‡å‡†æ¶ˆæ¯æ ¼å¼** - `{"type": "market", "assets_ids": [...]}`
- âœ… **PINGå¿ƒè·³** - æ¯10ç§’å‘é€å¿ƒè·³ä¿æŒè¿æ¥
- âœ… **è‡ªåŠ¨é‡è¿** - è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨å°è¯•é‡è¿ï¼ˆæœ€å¤š5æ¬¡ï¼‰
- âœ… **ç¯å¢ƒå˜é‡æ§åˆ¶** - å¯è½»æ¾å¯ç”¨/ç¦ç”¨

### WebSocketè¿æ¥æµç¨‹

```typescript
1. æµè§ˆå™¨å¯åŠ¨ â†’ WebSocketå®¢æˆ·ç«¯åˆå§‹åŒ–
2. è¿æ¥ wss://ws-subscriptions-clob.polymarket.com/ws/market
3. è¿æ¥æˆåŠŸ â†’ è®¢é˜…token IDs: {"type": "market", "assets_ids": [...]}
4. å¯åŠ¨PINGå¿ƒè·³ï¼ˆæ¯10ç§’ï¼‰
5. æ¥æ”¶æ¶ˆæ¯ï¼š
   - book: è®¢å•ç°¿æ›´æ–°
   - price_change: ä»·æ ¼å˜åŒ–
   - trade: äº¤æ˜“æ‰§è¡Œï¼ˆæœ€å‡†ç¡®çš„æˆäº¤ä»·ï¼‰
6. ä»·æ ¼æ›´æ–° â†’ è§¦å‘å›è°ƒ â†’ MatchCardç»„ä»¶åˆ·æ–°
```

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

`.env` æ–‡ä»¶ï¼š

```bash
# WebSocketå¼€å…³
# true = å¯ç”¨WebSocketå®æ—¶æ›´æ–° (< 1ç§’å»¶è¿Ÿ)
# false = ä»…ä½¿ç”¨REST APIè½®è¯¢ (30ç§’å»¶è¿Ÿ)
VITE_ENABLE_WEBSOCKET=true
```

### ä»£ç†è¦æ±‚

**é‡è¦**ï¼šWebSocketè¿æ¥å¯èƒ½éœ€è¦ä»£ç†æ‰èƒ½è®¿é—®PolymarketæœåŠ¡å™¨

```bash
# Clashä»£ç†é…ç½®
HTTP_PROXY=http://127.0.0.1:7890
HTTPS_PROXY=http://127.0.0.1:7890
```

**ç¡®ä¿**ï¼š
- âœ… Clashæˆ–å…¶ä»–ä»£ç†å·¥å…·å·²å¯åŠ¨
- âœ… **ç³»ç»Ÿä»£ç†æ¨¡å¼**å·²å¼€å¯ï¼ˆæµè§ˆå™¨æ‰èƒ½é€šè¿‡ä»£ç†è®¿é—®WSSï¼‰
- âœ… ä»£ç†æ”¯æŒWebSocketåè®®

## ğŸŒ æµè§ˆå™¨ç›´è¿åŸç†

### ä¸ºä»€ä¹ˆä¸éœ€è¦Viteä»£ç†ï¼Ÿ

1. **CORSé™åˆ¶ä¸é€‚ç”¨äºWebSocket**
   - HTTP/HTTPSæœ‰åŒæºç­–ç•¥é™åˆ¶ï¼Œéœ€è¦ä»£ç†
   - WebSocketåè®®(ws://, wss://)ä¸å—CORSé™åˆ¶
   - æµè§ˆå™¨å¯ä»¥ç›´æ¥è¿æ¥ä»»ä½•WebSocketæœåŠ¡å™¨

2. **ç®€åŒ–æ¶æ„**
   ```
   âŒ æ—§æ–¹æ¡ˆï¼šæµè§ˆå™¨ â†’ Viteä»£ç† â†’ Polymarket WS
   âœ… æ–°æ–¹æ¡ˆï¼šæµè§ˆå™¨ --------â†’ Polymarket WS
   ```

3. **å‡å°‘æ•…éšœç‚¹**
   - ä¸ä¾èµ–Vite dev serverçš„WebSocketä»£ç†
   - å‡å°‘è¿æ¥å±‚æ•°å’Œæ½œåœ¨é”™è¯¯
   - æ›´ç¬¦åˆç”Ÿäº§ç¯å¢ƒæ¶æ„

## ğŸ“ æ¶ˆæ¯æ ¼å¼è¯¦è§£

### è®¢é˜…æ¶ˆæ¯

```json
{
  "type": "market",
  "assets_ids": [
    "21742633143463906290569050155826241533067272736897614950488156847949938836455",
    "52114319501245915516055106046884209969926127482827954674443846427813813222426"
  ]
}
```

### æ¥æ”¶åˆ°çš„æ¶ˆæ¯ç±»å‹

#### 1. è®¢å•ç°¿æ›´æ–° (book)
```json
{
  "event_type": "book",
  "asset_id": "...",
  "bids": [...],
  "asks": [...]
}
```

#### 2. ä»·æ ¼å˜åŒ– (price_change)
```json
{
  "event_type": "price_change",
  "price_changes": [
    {
      "asset_id": "...",
      "price": "0.52",
      "side": "BUY"
    }
  ]
}
```

#### 3. äº¤æ˜“æ‰§è¡Œ (trade)
```json
{
  "event_type": "trade",
  "trades": [
    {
      "asset_id": "...",
      "price": "0.525",
      "side": "BUY",
      "size": "100"
    }
  ]
}
```

## âš¡ æ€§èƒ½å¯¹æ¯”

| æ›´æ–°æ–¹å¼ | å»¶è¿Ÿ | å¹¶å‘è¯·æ±‚ | èµ„æºæ¶ˆè€— | å®æ—¶æ€§ |
|---------|------|---------|---------|--------|
| **WebSocket** | < 1ç§’ | 1ä¸ªè¿æ¥ | ä½ | â­â­â­â­â­ |
| **REST APIè½®è¯¢** | 30ç§’ | Nä¸ªç»„ä»¶ | é«˜ | â­â­ |

### WebSocketä¼˜åŠ¿

- âœ… **çœŸæ­£å®æ—¶** - æœåŠ¡å™¨æ¨é€ï¼Œæ— å»¶è¿Ÿ
- âœ… **ä½èµ„æºæ¶ˆè€—** - å•ä¸ªæŒä¹…è¿æ¥
- âœ… **å‡å°‘APIè¯·æ±‚** - ä¸éœ€è¦é¢‘ç¹è½®è¯¢
- âœ… **æ›´å‡†ç¡®çš„ä»·æ ¼** - æ•æ‰æ¯æ¬¡äº¤æ˜“

### REST APIè½®è¯¢ä¼˜åŠ¿

- âœ… **ç®€å•å¯é ** - æ— éœ€ç»´æŠ¤è¿æ¥çŠ¶æ€
- âœ… **æ— ä»£ç†é—®é¢˜** - HTTPä»£ç†é…ç½®ç®€å•
- âœ… **é™çº§æ–¹æ¡ˆ** - WebSocketå¤±è´¥æ—¶çš„å¤‡ä»½

## ğŸ”€ åŒæ¨¡å¼è¿è¡Œ

ç³»ç»ŸåŒæ—¶æ”¯æŒWebSocket + REST APIè½®è¯¢ï¼š

```typescript
// MatchCard.tsx é€»è¾‘
if (WEBSOCKET_ENABLED && WebSocketè¿æ¥æˆåŠŸ) {
  // WebSocketæ¨é€ä»·æ ¼æ›´æ–° (< 1ç§’)
  // REST APIè½®è¯¢é™ä½é¢‘ç‡ (30ç§’) ä½œä¸ºbackup
} else {
  // ä»…REST APIè½®è¯¢ (30ç§’)
}
```

**å¥½å¤„**ï¼š
- WebSocketæä¾›å®æ—¶æ›´æ–°
- REST APIç¡®ä¿æ•°æ®ä¸ä¼šä¸¢å¤±
- è‡ªåŠ¨é™çº§åˆ°REST APIï¼ˆWebSocketå¤±è´¥æ—¶ï¼‰

## ğŸ› å¸¸è§é—®é¢˜

### 1. ERR_INSUFFICIENT_RESOURCES

**é—®é¢˜**ï¼šå¤šä¸ªç»„ä»¶åŒæ—¶å‘èµ·å¤§é‡è¯·æ±‚
**è§£å†³**ï¼š
- âœ… æ·»åŠ éšæœºå»¶è¿Ÿï¼ˆ0-5ç§’ï¼‰
- âœ… é™ä½è½®è¯¢é¢‘ç‡ï¼ˆ30ç§’ï¼‰
- âœ… å¯ç”¨WebSocketå‡å°‘REST APIè¯·æ±‚

### 2. WebSocketè¿æ¥è¶…æ—¶

**é—®é¢˜**ï¼š`ETIMEDOUT` æˆ– `ECONNRESET`
**å¯èƒ½åŸå› **ï¼š
- âŒ ä»£ç†æœªå¯åŠ¨æˆ–æœªè®¾ç½®ç³»ç»Ÿä»£ç†æ¨¡å¼
- âŒ PolymarketæœåŠ¡å™¨IPé™åˆ¶
- âŒ ç½‘ç»œé˜²ç«å¢™é˜»æ­¢WSSè¿æ¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤Clashç³»ç»Ÿä»£ç†å·²å¯ç”¨
2. æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦èƒ½è®¿é—® https://polymarket.com
3. å¦‚ä»æ— æ³•è¿æ¥ï¼Œç¦ç”¨WebSocketä½¿ç”¨REST APIï¼š
   ```bash
   VITE_ENABLE_WEBSOCKET=false
   ```

### 3. PINGå¿ƒè·³æ— å“åº”

**é—®é¢˜**ï¼šè¿æ¥å»ºç«‹åå¾ˆå¿«æ–­å¼€
**è§£å†³**ï¼š
- âœ… å·²å®ç°PINGå¿ƒè·³ï¼ˆæ¯10ç§’ï¼‰
- âœ… è‡ªåŠ¨å¤„ç†PONGå“åº”
- âœ… è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨é‡è¿

## ğŸ“ˆ ç›‘æ§å’Œè°ƒè¯•

### æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—

**æˆåŠŸè¿æ¥**ï¼š
```
[WebSocket] Client initialized
[WebSocket] ç›´è¿URL: wss://ws-subscriptions-clob.polymarket.com/ws/market
[WebSocket] âœ“ Connected
[WebSocket] Subscribing to 2 tokens: {...}
[WebSocket] ğŸ’“ PING sent
[WebSocket] Message received: {...}
[WebSocket] ğŸ”¥ Trade executed: 2174263314... @ 0.52
```

**è¿æ¥å¤±è´¥**ï¼š
```
[WebSocket] Connection failed: ...
[WebSocket] Attempting to reconnect (1/5) in 3s
```

### Chrome DevTools Network

1. æ‰“å¼€ DevTools â†’ Network â†’ WS (WebSocketè¿‡æ»¤å™¨)
2. æŸ¥çœ‹ `ws-subscriptions-clob.polymarket.com` è¿æ¥çŠ¶æ€
3. ç‚¹å‡»æŸ¥çœ‹å‘é€/æ¥æ”¶çš„æ¶ˆæ¯

## ğŸš€ æœªæ¥ä¼˜åŒ–

### å¯èƒ½çš„æ”¹è¿›

1. **è¿æ¥æ± ç®¡ç†** - å¤šä¸ªç»„ä»¶å…±äº«å•ä¸ªWebSocketè¿æ¥
2. **æ¶ˆæ¯é˜Ÿåˆ—** - ç¼“å†²ä»·æ ¼æ›´æ–°ï¼Œæ‰¹é‡å¤„ç†
3. **æ™ºèƒ½é‡è¿** - æ ¹æ®ç½‘ç»œçŠ¶å†µè°ƒæ•´é‡è¿ç­–ç•¥
4. **å‹ç¼©ä¼ è¾“** - å‡å°‘å¸¦å®½æ¶ˆè€—
5. **å¤‡é€‰endpoint** - å°è¯• `wss://ws-live-data.polymarket.com`

### å½“å‰é™åˆ¶

- æ¯ä¸ªMatchCardç»„ä»¶ç‹¬ç«‹è®¢é˜…ï¼ˆå¯ä¼˜åŒ–ä¸ºå…±äº«è¿æ¥ï¼‰
- ä¸æ”¯æŒå†å²æ•°æ®å›æ”¾
- ä¾èµ–æµè§ˆå™¨WebSocket APIï¼ˆIEä¸æ”¯æŒï¼‰

## âœ… æ€»ç»“

### å½“å‰å®ç° âœ…

- [x] WebSocketå®¢æˆ·ç«¯å®ç°
- [x] æµè§ˆå™¨ç›´è¿ï¼ˆä¸é€šè¿‡ä»£ç†ï¼‰
- [x] æ ‡å‡†è®¢é˜…æ¶ˆæ¯æ ¼å¼
- [x] PINGå¿ƒè·³ä¿æ´»
- [x] è‡ªåŠ¨é‡è¿æœºåˆ¶
- [x] ç¯å¢ƒå˜é‡æ§åˆ¶
- [x] å¤šç§æ¶ˆæ¯ç±»å‹æ”¯æŒ
- [x] é™çº§åˆ°REST API

### æ¨èé…ç½® â­

```bash
# .env
VITE_ENABLE_WEBSOCKET=true  # å¯ç”¨WebSocket
HTTP_PROXY=http://127.0.0.1:7890  # Clashä»£ç†
HTTPS_PROXY=http://127.0.0.1:7890
```

**ç¡®ä¿Clashç³»ç»Ÿä»£ç†å·²å¯ç”¨ï¼**

### ä½¿ç”¨å»ºè®®

1. **é¦–é€‰WebSocket** - å®æ—¶æ€§æœ€ä½³
2. **å¤‡ä»½REST API** - è‡ªåŠ¨é™çº§
3. **ç›‘æ§æ—¥å¿—** - ç¡®è®¤è¿æ¥çŠ¶æ€
4. **ç½‘ç»œé—®é¢˜æ—¶ç¦ç”¨** - è®¾ç½® `VITE_ENABLE_WEBSOCKET=false`

---

ğŸ“… æœ€åæ›´æ–°ï¼š2025-11-25
ğŸ“ æ–‡æ¡£ç‰ˆæœ¬ï¼šv2.0
